<!DOCTYPE html>
<html lang="en" dir="ltr" class="light"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plasticology Ultimate Edition</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e293b">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://pub-fb0d46cb77cb4e22b5863540fe118da4.r2.dev/Plasticology%202025%20Logo%20white%20outline.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <canvas id="login-canvas"></canvas>

    <div id="login-container-wrapper">
        <div id="login-container" class="w-full">
             <div class="login-card-box">
                <img id="login-logo" src="https://pub-fb0d46cb77cb4e22b5863540fe118da4.r2.dev/Plasticology%202025%20Logo%20white%20outline.png" alt="Logo" class="h-20 mx-auto mb-4">
                <div class="text-center mb-6">
                    <h1 class="text-2xl font-bold text-slate-800 dark:text-white">Welcome To Plasticology</h1>
                    <p class="text-slate-500 mt-1">Ultimate Edition v4.0</p>
                </div>
                
                <div id="pwa-install-banner" class="hidden mb-6 p-4 bg-indigo-50 border border-indigo-100 rounded-xl text-center shadow-sm">
                    <button id="pwa-install-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm shadow-md">
                        Install App
                    </button>
                </div>

                <div id="login-loader" class="loader hidden"></div>
                <p id="login-loading-text" class="text-center text-slate-500 hidden">Loading...</p>
                
                <form id="login-form" class="space-y-5">
                    <div class="relative">
                        <i class="fas fa-user absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="username" class="w-full pl-10 py-3" placeholder="Username" required autocomplete="off">
                    </div>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="password" id="password" class="w-full pl-10 py-3" placeholder="Password" required>
                    </div>
                    <p id="login-error" class="text-red-500 text-sm text-center hidden"></p>
                    <button type="submit" id="login-submit-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform hover:-translate-y-1">
                        Log In
                    </button>
                </form>
                
                <div class="mt-6 text-center space-y-2">
                    <a href="#" id="show-register-link" class="text-sm text-blue-600 hover:underline">Create New Account</a>
                    <button type="button" id="free-test-btn" class="block w-full text-center text-sm text-slate-500 hover:text-slate-700">Try Free Test</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app-shell" class="hidden">
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="https://pub-fb0d46cb77cb4e22b5863540fe118da4.r2.dev/Plasticology%202025%20Logo%20white%20outline.png" alt="Logo" class="h-8 w-auto">
                <span class="font-bold text-lg tracking-wide">Plasticology</span>
            </div>
            
            <nav class="sidebar-nav">
                <a class="nav-item active" data-target="home"><i class="fas fa-home"></i> Dashboard</a>
                <a class="nav-item" data-target="lectures"><i class="fas fa-play-circle"></i> Lectures</a>
                <a class="nav-item" data-target="exams"><i class="fas fa-question-circle"></i> QBank & Exams</a>
                <a class="nav-item" data-target="osce"><i class="fas fa-user-md"></i> OSCE</a>
                <a class="nav-item" data-target="planner"><i class="fas fa-calendar-alt"></i> Study Planner</a>
                <div class="my-2 border-t border-slate-700"></div>
                <a class="nav-item" data-target="notes"><i class="fas fa-sticky-note"></i> My Notes</a>
                <a class="nav-item" data-target="activity"><i class="fas fa-chart-line"></i> History</a>
            </nav>
            
            <div class="sidebar-footer">
                <button id="sidebar-logout-btn" class="flex items-center gap-2 text-red-400 hover:text-red-300 transition-colors w-full">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </aside>

        <main class="main-content">
            
            <header class="app-header">
                <div class="flex items-center gap-3">
                    <img src="https://pub-fb0d46cb77cb4e22b5863540fe118da4.r2.dev/Plasticology%202025%20Logo%20white%20outline.png" alt="Logo" class="h-8 md:hidden">
                    <h2 id="header-title" class="header-title">Dashboard</h2>
                </div>
                
                <div class="flex items-center gap-3">
                    <div id="streak-container" class="flex items-center bg-orange-100 text-orange-600 px-3 py-1 rounded-full font-bold text-sm border border-orange-200">
                        <i class="fas fa-fire mr-1"></i> <span id="streak-count">0</span>
                    </div>
                    
                    <button id="toggle-theme-btn" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-slate-600 dark:text-slate-300">
                        <i class="fas fa-sun sun-icon hidden"></i>
                        <i class="fas fa-moon moon-icon"></i>
                    </button>
                    
                    <button id="user-profile-header-btn">
                        <img id="header-user-avatar" src="https://api.dicebear.com/7.x/initials/svg?seed=User" class="w-9 h-9 rounded-full border border-slate-300">
                    </button>
                </div>
            </header>

            <div class="content-scrollable" id="content-wrapper">

                <div id="main-menu-container" class="w-full hidden fade-in">
                    
                    <div class="welcome-card">
                        <div class="relative z-10">
                            <h1 class="text-3xl font-bold mb-2">Welcome, <span id="user-name-display">Doctor</span></h1>
                            <p class="opacity-90 mb-6">Ready to master Plastic Surgery today?</p>
                            <div class="flex gap-3">
                                <button id="dashboard-quick-quiz-btn" class="bg-white text-blue-700 font-bold py-2 px-5 rounded-lg shadow hover:bg-blue-50 transition">
                                    <i class="fas fa-play mr-2"></i> Quick Quiz
                                </button>
                                <button id="announcements-btn" class="bg-blue-600 text-white border border-blue-400 font-bold py-2 px-5 rounded-lg hover:bg-blue-500 transition">
                                    <i class="fas fa-bell mr-2"></i> Updates
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="quick-actions">
                         <div class="action-card" onclick="document.getElementById('leaderboard-btn').click()">
                            <div class="action-icon bg-yellow-soft"><i class="fas fa-trophy"></i></div>
                            <div><p class="text-xs text-slate-500 font-bold uppercase">Rank</p><p class="font-bold text-slate-800 dark:text-white">Leaderboard</p></div>
                        </div>
                        <div class="action-card" onclick="document.getElementById('radio-btn').click()">
                            <div class="action-icon bg-purple-soft"><i class="fas fa-broadcast-tower"></i></div>
                            <div><p class="text-xs text-slate-500 font-bold uppercase">Radio</p><p class="font-bold text-slate-800 dark:text-white">Plasticology FM</p></div>
                        </div>
                         <div class="action-card" onclick="document.getElementById('notes-btn').click()">
                            <div class="action-icon bg-green-soft"><i class="fas fa-book"></i></div>
                            <div><p class="text-xs text-slate-500 font-bold uppercase">Study</p><p class="font-bold text-slate-800 dark:text-white">My Notes</p></div>
                        </div>
                    </div>

                    <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4 px-1">Study Modules</h3>
                    
                    <div class="modules-grid">
                        <div id="lectures-btn" class="module-card group">
                            <div class="module-icon-circle"><i class="fas fa-video"></i></div>
                            <span class="module-title">Lectures</span>
                            <span class="module-desc">Video Library</span>
                        </div>

                        <div id="qbank-btn" class="module-card group">
                            <div class="module-icon-circle"><i class="fas fa-graduation-cap"></i></div>
                            <span class="module-title">QBank</span>
                            <span class="module-desc">Exams & Sim</span>
                        </div>

                        <div id="learning-mode-btn" class="module-card group">
                            <div class="module-icon-circle"><i class="fas fa-book-reader"></i></div>
                            <span class="module-title">Learning</span>
                            <span class="module-desc">Q&A Study</span>
                        </div>

                        <div id="osce-btn" class="module-card group">
                            <div class="module-icon-circle"><i class="fas fa-user-md"></i></div>
                            <span class="module-title">OSCE</span>
                            <span class="module-desc">Clinical Cases</span>
                        </div>

                        <div id="theory-btn" class="module-card group">
                            <div class="module-icon-circle"><i class="fas fa-feather-alt"></i></div>
                            <span class="module-title">Theory</span>
                            <span class="module-desc">Essay Bank</span>
                        </div>

                        <div id="matching-btn" class="module-card group">
                            <div class="module-icon-circle"><i class="fas fa-puzzle-piece"></i></div>
                            <span class="module-title">Matching</span>
                            <span class="module-desc">Connect Terms</span>
                        </div>
                        
                        <div id="study-planner-btn" class="module-card group">
                            <div class="module-icon-circle"><i class="fas fa-calendar-check"></i></div>
                            <span class="module-title">Planner</span>
                            <span class="module-desc">Schedule</span>
                        </div>

                         <div id="library-btn" class="module-card group">
                            <div class="module-icon-circle"><i class="fas fa-book-open"></i></div>
                            <span class="module-title">Library</span>
                            <span class="module-desc">References</span>
                        </div>

                        <button id="leaderboard-btn" class="hidden"></button>
                        <button id="radio-btn" class="hidden"></button>
                        <button id="notes-btn" class="hidden"></button>
                        <button id="activity-log-btn" class="hidden"></button>
                        <button id="messenger-btn" class="hidden"></button>
                        <button id="logout-btn" class="hidden"></button>
                        <button id="global-home-btn" class="hidden"></button>
                        <div id="last-lecture-ribbon" class="hidden"></div>
                        <div id="last-quiz-ribbon" class="hidden"></div>
                    </div>
                    
                    <div id="radio-banner-container" class="mt-6 hidden rounded-lg overflow-hidden bg-slate-100 transition-all">
                        <div class="p-2 bg-slate-800 text-white flex justify-between items-center">
                            <span class="font-bold text-sm ml-2">Plasticology Radio</span>
                            <button id="radio-close-btn" class="text-white hover:text-gray-300 px-2">&times;</button>
                        </div>
                        <iframe src="https://plasticologyradio.surgerymastersacademy.com/" class="w-full h-48 border-0"></iframe>
                    </div>
                </div>

                <div id="qbank-container" class="w-full hidden">
                    <div class="back-nav">
                        <button id="qbank-back-btn" class="back-btn-circle"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="text-2xl font-bold">Question Bank</h2>
                    </div>
                    
                    <div id="qbank-main-content">
                         <div class="mb-6 bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                            <div class="flex gap-2">
                                <input type="text" id="qbank-search-input" class="flex-1 border-none bg-slate-50 dark:bg-slate-700 rounded-lg px-4 py-3" placeholder="Search topics...">
                                <button id="qbank-search-btn" class="bg-blue-600 text-white px-6 rounded-lg hover:bg-blue-700"><i class="fas fa-search"></i></button>
                            </div>
                             <p id="qbank-search-error" class="text-red-500 text-xs mt-2 hidden"></p>
                        </div>

                        <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                            <button id="qbank-tab-create" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-full font-bold whitespace-nowrap active-tab">Create Exam</button>
                            <button id="qbank-tab-practice" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-full font-medium whitespace-nowrap hover:bg-slate-200">Practice</button>
                            <button id="qbank-tab-browse" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-full font-medium whitespace-nowrap hover:bg-slate-200">Browse</button>
                        </div>

                        <div id="qbank-panel-create" class="space-y-6">
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                                <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fas fa-stopwatch text-emerald-500"></i> Quick Mock Exam</h3>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <input type="number" id="mock-q-count" class="border rounded-lg p-3 dark:bg-slate-700" placeholder="Questions (10)">
                                    <input type="number" id="custom-timer-input" class="border rounded-lg p-3 dark:bg-slate-700" placeholder="Time/Q (sec)">
                                </div>
                                <button id="toggle-custom-options-btn" class="text-sm text-blue-600 font-medium mb-4 flex items-center gap-1">
                                    <i class="fas fa-filter"></i> Filter by Source/Chapter
                                </button>
                                <div id="custom-exam-options" class="custom-exam-options hidden mb-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div id="source-select-mock" class="max-h-40 overflow-y-auto border p-2 rounded"></div>
                                        <div id="chapter-select-mock" class="max-h-40 overflow-y-auto border p-2 rounded"></div>
                                    </div>
                                </div>
                                <button id="start-mock-btn" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg hover:bg-emerald-700 shadow-lg">Start Mock Exam</button>
                                <p id="mock-error" class="text-red-500 text-xs mt-2 hidden"></p>
                            </div>

                            <div class="bg-gradient-to-br from-slate-800 to-slate-900 text-white p-6 rounded-xl shadow-lg">
                                <div>
                                    <h3 class="text-lg font-bold mb-1 flex items-center gap-2"><i class="fas fa-flag-checkered text-red-400"></i> Exam Simulation</h3>
                                    <p class="text-slate-400 text-sm mb-4">100 Questions • 120 Minutes • Real Exam Feel</p>
                                </div>
                                
                                <button id="toggle-simulation-options-btn" class="text-sm text-blue-300 font-medium mb-4 flex items-center gap-1 hover:text-white">
                                    <i class="fas fa-sliders-h"></i> Customize Sources
                                </button>

                                <div id="simulation-custom-options" class="hidden mb-4 bg-slate-800/50 p-3 rounded border border-slate-700">
                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-slate-300">
                                        <div>
                                            <p class="text-xs uppercase font-bold mb-2 text-slate-500">Sources</p>
                                            <div id="source-select-sim" class="max-h-32 overflow-y-auto"></div>
                                        </div>
                                        <div>
                                            <p class="text-xs uppercase font-bold mb-2 text-slate-500">Chapters</p>
                                            <div id="chapter-select-sim" class="max-h-32 overflow-y-auto"></div>
                                        </div>
                                    </div>
                                </div>

                                <button id="start-simulation-btn" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-500 shadow-lg">Enter Simulation Mode</button>
                                <p id="simulation-error" class="text-red-300 text-xs mt-2 hidden"></p>
                            </div>
                        </div>

                        <div id="qbank-panel-practice" class="hidden">
                             <div class="grid grid-cols-1 gap-4">
                                <button id="practice-mistakes-btn" class="p-6 rounded-xl bg-orange-50 border border-orange-100 text-orange-800 font-bold text-left hover:bg-orange-100 transition">
                                    <i class="fas fa-history mr-2"></i> Practice My Mistakes
                                </button>
                                <button id="practice-bookmarked-btn" class="p-6 rounded-xl bg-blue-50 border border-blue-100 text-blue-800 font-bold text-left hover:bg-blue-100 transition">
                                    <i class="fas fa-bookmark mr-2"></i> Practice Bookmarked
                                </button>
                            </div>
                        </div>
                        
                        <div id="qbank-panel-browse" class="hidden">
                             <div class="grid grid-cols-1 gap-4">
                                <button id="browse-by-chapter-btn" class="p-4 bg-white border rounded-lg font-bold text-slate-700">Browse by Chapter</button>
                                <button id="browse-by-source-btn" class="p-4 bg-white border rounded-lg font-bold text-slate-700">Browse by Source</button>
                            </div>
                        </div>
                        
                        <div id="qbank-search-results-container" class="hidden bg-white p-4 rounded-lg mt-4">
                             <button id="qbank-clear-search-btn" class="text-sm text-blue-500 mb-2">Clear Search</button>
                             <p id="qbank-search-results-info" class="font-bold mb-2"></p>
                             <button id="qbank-start-search-quiz-btn" class="bg-green-600 text-white px-4 py-2 rounded">Start Search Quiz</button>
                        </div>
                     </div>
                </div>

                <div id="lectures-container" class="w-full hidden">
                    <div class="back-nav">
                        <button id="lectures-back-btn" class="back-btn-circle"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="text-2xl font-bold">Video Lectures</h2>
                    </div>
                    <div class="relative mb-6">
                        <input type="text" id="lecture-search-input" placeholder="Find a topic..." class="w-full p-4 pl-12 bg-white border-none rounded-xl shadow-sm focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    </div>
                    <div id="lectures-loader" class="loader"></div>
                    <div id="lectures-list" class="space-y-4"></div>
                </div>

                <div id="quiz-container" class="w-full hidden h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4 bg-white p-3 rounded-lg shadow-sm">
                        <button id="end-quiz-btn" class="text-red-500 hover:bg-red-50 p-2 rounded"><i class="fas fa-times"></i> End</button>
                        <h2 id="quiz-title" class="font-bold text-sm truncate max-w-[150px]">Quiz</h2>
                        <div id="timer" class="font-mono font-bold text-lg bg-slate-100 px-3 py-1 rounded">00:00</div>
                    </div>
                    
                    <div class="mb-2">
                        <div class="flex justify-between text-xs text-slate-500 mb-1">
                            <span id="progress-text">Q 1</span>
                            <span id="score-progress-text">0/0</span>
                        </div>
                        <div id="progress-bar-container" class="h-2 bg-slate-200 rounded-full overflow-hidden flex">
                             <div id="score-bar-correct" class="bg-green-500 h-full" style="width:0%"></div>
                             <div id="score-bar-incorrect" class="bg-red-500 h-full" style="width:0%"></div>
                             <div id="score-bar-answered" class="bg-blue-500 h-full hidden" style="width:0%"></div>
                        </div>
                    </div>
                    
                    <div id="question-container" class="flex-1 overflow-y-auto bg-white p-5 rounded-xl shadow-sm relative">
                         <p id="source-text" class="text-xs text-slate-400 text-right mb-2"></p>
                         <div id="question-image-container" class="mb-4 text-center"></div>
                         <h2 id="question-text" class="text-xl font-bold text-slate-800 mb-6 leading-relaxed"></h2>
                         <div id="answer-buttons-quiz" class="space-y-3"></div>
                         <div id="hint-text" class="hidden mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 text-sm"></div>
                    </div>

                    <div id="controls-container" class="mt-4 flex justify-between items-center bg-white p-3 rounded-xl shadow-sm">
                        <button id="previous-btn" class="px-4 py-2 text-slate-500 font-bold">Prev</button>
                        <div class="flex gap-3 text-xl text-slate-400">
                            <button id="navigator-btn"><i class="fas fa-th"></i></button>
                            <button id="bookmark-btn" class="bookmark-btn"><i class="far fa-bookmark"></i></button>
                            <button id="flag-btn" class="flag-btn"><i class="far fa-flag"></i></button>
                            <button id="hint-btn"><i class="fas fa-lightbulb"></i></button>
                            <button id="quiz-note-btn" class="note-icon"><i class="fas fa-sticky-note"></i></button>
                        </div>
                        <button id="next-skip-btn" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700">Next</button>
                    </div>
                    
                    <div id="results-container" class="hidden text-center pt-10">
                         <i class="fas fa-trophy text-6xl text-yellow-400 mb-4"></i>
                         <h2 id="results-title" class="text-2xl font-bold">Complete!</h2>
                         <p class="text-xl my-4">Score: <span id="score-text" class="font-bold"></span> / <span id="total-questions"></span></p>
                         <div class="flex flex-col gap-3 max-w-xs mx-auto">
                             <button id="results-home-btn" class="p-3 bg-gray-600 text-white rounded font-bold">Home</button>
                             <button id="restart-btn" class="p-3 bg-blue-600 text-white rounded font-bold">Restart</button>
                             <button id="review-incorrect-btn" class="hidden p-3 bg-red-500 text-white rounded font-bold">Review Incorrect</button>
                             <button id="review-simulation-btn" class="hidden p-3 bg-purple-600 text-white rounded font-bold">Review All</button>
                         </div>
                    </div>
                </div>

                <div id="matching-container" class="w-full hidden">
                    <div id="matching-menu-container">
                         <div class="back-nav">
                            <button id="matching-back-btn" class="back-btn-circle"><i class="fas fa-arrow-left"></i></button>
                            <h2 class="text-2xl font-bold">Matching Game</h2>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                            <input id="matching-set-count" type="number" placeholder="Sets (10)" class="border p-2 rounded w-full mb-4">
                            <input id="matching-timer-input" type="number" placeholder="Sec/Set (60)" class="border p-2 rounded w-full mb-4">
                             <div id="chapter-select-matching" class="hidden"></div>
                             <div id="source-select-matching" class="hidden"></div>
                            <button id="start-matching-btn" class="w-full bg-pink-600 text-white font-bold py-3 rounded-lg">Start Game</button>
                            <p id="matching-error" class="hidden text-red-500 mt-2"></p>
                        </div>
                    </div>
                     <div id="matching-game-container" class="hidden h-full flex flex-col">
                         <div class="flex justify-between mb-2 p-2 bg-white rounded shadow-sm">
                             <button id="end-matching-btn" class="text-red-500"><i class="fas fa-stop"></i></button>
                             <span id="matching-progress" class="font-bold"></span>
                             <span id="matching-timer" class="font-mono bg-slate-100 px-2 rounded">00:00</span>
                             <span id="matching-score" class="text-blue-600 font-bold"></span>
                         </div>
                         <div class="matching-container-grid flex-1 overflow-y-auto pb-20">
                             <div id="matching-premises-area"></div>
                             <div id="matching-answers-area"></div>
                         </div>
                         <div class="mt-2 flex gap-2 fixed bottom-16 left-4 right-4 md:static md:bottom-auto">
                             <button id="matching-submit-btn" class="flex-1 bg-green-600 text-white p-3 rounded shadow-lg font-bold">Check</button>
                             <button id="matching-next-btn" class="hidden flex-1 bg-blue-600 text-white p-3 rounded shadow-lg font-bold">Next</button>
                         </div>
                     </div>
                </div>

                <div id="learning-mode-container" class="w-full hidden">
                    <div id="learning-mode-controls">
                        <div class="back-nav">
                            <button id="learning-mode-back-btn" class="back-btn-circle"><i class="fas fa-arrow-left"></i></button>
                            <h2 class="text-2xl font-bold">Learning Mode</h2>
                        </div>
                         <div class="p-4 bg-white rounded-xl shadow-sm">
                             <input type="text" id="learning-search-input" class="w-full border rounded p-2 mb-4" placeholder="Search...">
                             <button id="learning-search-btn" class="hidden"></button>
                             <div class="grid gap-3">
                                 <button id="learning-browse-by-chapter-btn" class="p-3 bg-slate-100 rounded font-bold">Browse Chapters</button>
                                 <button id="learning-browse-by-source-btn" class="p-3 bg-slate-100 rounded font-bold">Browse Sources</button>
                                 <button id="learning-mistakes-btn" class="p-3 bg-orange-100 text-orange-800 rounded font-bold">My Mistakes</button>
                                 <button id="learning-bookmarked-btn" class="p-3 bg-blue-100 text-blue-800 rounded font-bold">Bookmarked</button>
                             </div>
                             <p id="learning-search-error" class="hidden text-red-500"></p>
                         </div>
                    </div>
                    <div id="learning-mode-viewer" class="hidden h-full flex flex-col">
                         <div class="flex justify-between items-center mb-4">
                            <button id="end-learning-btn" class="text-red-500 font-bold">Exit</button>
                            <h3 id="learning-title" class="font-bold truncate">Topic</h3>
                        </div>
                        <div class="flex-1 overflow-y-auto bg-white p-4 rounded-xl shadow-sm">
                            <p id="learning-progress-text" class="text-center text-sm text-gray-500 mb-2">Loading...</p>
                            <p id="learning-source-text" class="text-center text-xs text-gray-400"></p>
                            <div id="learning-image-container" class="my-2 text-center"></div>
                            <h2 id="learning-question-text" class="text-lg font-bold mb-4"></h2>
                            <div id="learning-answer-buttons" class="space-y-3"></div>
                        </div>
                        <div class="mt-4 flex justify-between">
                            <button id="learning-previous-btn" class="px-4 py-2 bg-gray-200 rounded">Prev</button>
                            <button id="learning-next-btn" class="px-4 py-2 bg-blue-600 text-white rounded">Next</button>
                        </div>
                    </div>
                </div>

                <div id="osce-container" class="w-full hidden">
                     <div class="back-nav">
                        <button id="osce-back-btn" class="back-btn-circle"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="text-2xl font-bold">OSCE</h2>
                    </div>
                    <div id="osce-controls" class="p-4 bg-white rounded-xl shadow-sm">
                        <button id="start-osce-slayer-btn" class="w-full bg-red-600 text-white p-4 rounded-lg font-bold mb-6">Start OSCE Slayer</button>
                        <h3 class="font-bold mb-2">Custom OSCE</h3>
                        <div class="flex gap-2 mb-2">
                            <input id="osce-case-count" type="number" placeholder="# Cases" class="border p-2 rounded w-1/2">
                            <input id="osce-time-per-q" type="number" placeholder="Mins/Q" class="border p-2 rounded w-1/2">
                        </div>
                         <button id="toggle-osce-options-btn" class="text-sm text-blue-600 mb-2">Filter</button>
                         <div id="custom-osce-options" class="hidden mb-2">
                             <div id="chapter-select-osce"></div>
                             <div id="source-select-osce"></div>
                         </div>
                        <button id="start-custom-osce-btn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Start Custom</button>
                         <p id="osce-error" class="text-red-500 hidden"></p>
                    </div>
                </div>
                <div id="osce-quiz-container" class="hidden w-full h-full flex flex-col">
                     <div class="flex justify-between p-2 bg-slate-100">
                        <button id="end-osce-quiz-btn" class="text-red-500"><i class="fas fa-stop"></i></button>
                        <span id="osce-quiz-title"></span>
                        <span id="osce-score"></span>
                        <span id="osce-timer">00:00</span>
                    </div>
                    <div class="flex-1 overflow-y-auto p-2">
                        <p id="osce-progress-text" class="text-center text-xs text-gray-500"></p>
                        <div class="bg-white p-2 rounded border mb-2">
                            <h3 id="osce-case-title" class="font-bold"></h3>
                            <div id="osce-case-image-container"></div>
                            <p id="osce-case-description" class="text-sm"></p>
                        </div>
                        <div class="bg-white p-2 rounded border">
                            <div id="osce-question-image-container"></div>
                            <h3 id="osce-question-text" class="font-bold"></h3>
                            <div id="osce-answer-area"></div>
                            <div id="osce-model-answer-area" class="hidden"></div>
                            <div id="osce-self-correction-area" class="hidden"></div>
                        </div>
                    </div>
                     <div id="osce-controls-container" class="mt-auto flex justify-between pt-2 bg-white p-2">
                        <button id="osce-previous-btn" class="p-2 bg-gray-200 rounded">Prev</button>
                        <button id="osce-navigator-btn"><i class="fas fa-list"></i></button>
                        <button id="osce-next-btn" class="p-2 bg-blue-600 text-white rounded">Next</button>
                    </div>
                </div>

                <div id="theory-container" class="w-full hidden">
                    <div class="back-nav">
                         <button id="theory-back-btn" class="back-btn-circle"><i class="fas fa-arrow-left"></i></button>
                         <h2 class="text-2xl font-bold">Theory</h2>
                    </div>
                    <div id="theory-controls">
                        <input type="text" id="theory-search-input" class="w-full border p-2 rounded mb-4" placeholder="Search...">
                        <button id="theory-search-btn" class="hidden"></button>
                        <div class="grid gap-2 mb-4">
                            <button id="theory-flashcard-mode-btn" class="p-3 bg-yellow-100 text-yellow-800 rounded font-bold">Flashcards</button>
                            <button id="theory-exam-mode-btn" class="p-3 bg-orange-100 text-orange-800 rounded font-bold">Exam Mode</button>
                        </div>
                        <button id="theory-browse-by-chapter-btn" class="w-full p-2 bg-slate-100 rounded mb-2">Chapters</button>
                        <button id="theory-browse-by-source-btn" class="w-full p-2 bg-slate-100 rounded">Sources</button>
                    </div>
                     <div id="theory-viewer" class="hidden h-full flex flex-col">
                        <div class="flex justify-between mb-2">
                             <button id="theory-end-btn" class="text-red-500">End</button>
                             <h2 id="theory-title"></h2>
                             <span id="theory-timer"></span>
                        </div>
                        <div class="bg-white p-4 rounded shadow-sm flex-1 overflow-y-auto">
                             <p id="theory-progress-text" class="text-center text-sm text-gray-400 mb-2"></p>
                             <p id="theory-source-text" class="text-xs text-gray-300"></p>
                             <div id="theory-img-container"></div>
                             <h3 id="theory-question-text" class="text-xl font-bold mb-4"></h3>
                             <div id="theory-answer-container" class="hidden bg-green-50 p-3 rounded border-l-4 border-green-500">
                                 <p id="theory-answer-text"></p>
                             </div>
                             <button id="theory-show-answer-btn" class="mt-4 w-full bg-blue-100 text-blue-700 p-2 rounded">Show Answer</button>
                        </div>
                         <div class="mt-2 flex justify-between items-center">
                            <button id="theory-prev-btn" class="p-2 bg-gray-200 rounded">Prev</button>
                            <div class="flex gap-2">
                                <button id="theory-note-btn" class="note-icon text-xl text-gray-400"><i class="fas fa-sticky-note"></i></button>
                                <button id="theory-status-btn" class="text-xl text-gray-400"><i class="far fa-check-circle"></i></button>
                            </div>
                            <button id="theory-next-btn" class="p-2 bg-blue-600 text-white rounded">Next</button>
                        </div>
                    </div>
                </div>

                <div id="study-planner-container" class="w-full hidden">
                     <div class="back-nav">
                        <button id="study-planner-back-btn" class="back-btn-circle"><i class="fas fa-arrow-left"></i></button>
                         <h2 class="text-2xl font-bold">Planner</h2>
                    </div>
                    <div id="planner-dashboard">
                         <button id="show-create-plan-modal-btn" class="w-full bg-green-600 text-white p-3 rounded mb-4">New Plan</button>
                         <div id="study-plans-list"></div>
                         <div id="performance-insights-container" class="hidden"><ul id="strengths-list"></ul><ul id="weaknesses-list"></ul></div>
                    </div>
                    <div id="active-plan-view" class="hidden">
                        <button id="back-to-plans-dashboard-btn" class="text-blue-500 mb-2">Back</button>
                        <h3 id="active-plan-name" class="font-bold text-xl"></h3>
                         <div id="study-plan-summary" class="bg-white p-4 rounded shadow mb-4">
                             <p>Remaining: <span id="plan-days-remaining"></span></p>
                             <p>Tasks: <span id="plan-tasks-today"></span></p>
                             <div class="bg-gray-200 h-2 rounded mt-2"><div id="plan-progress-bar" class="bg-green-500 h-full" style="width:0%"></div></div>
                         </div>
                         <div id="study-plan-days-container"></div>
                    </div>
                    <div id="study-planner-loader" class="loader hidden"></div>
                </div>

                <div id="leaderboard-container" class="w-full hidden">
                     <div class="back-nav">
                        <button id="leaderboard-back-btn" class="back-btn-circle"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="text-2xl font-bold">Leaderboard</h2>
                    </div>
                    <div id="leaderboard-loader" class="loader hidden"></div>
                    <div id="current-user-rank"></div>
                    <div id="leaderboard-list" class="space-y-2"></div>
                </div>

                <div id="notes-container" class="w-full hidden">
                     <div class="back-nav">
                        <button id="notes-back-btn" class="back-btn-circle"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="text-2xl font-bold">My Notes</h2>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <button id="notes-filter-quizzes" class="flex-1 bg-slate-200 p-2 rounded">Quiz</button>
                        <button id="notes-filter-lectures" class="flex-1 bg-slate-200 p-2 rounded">Lecture</button>
                        <button id="notes-filter-theory" class="flex-1 bg-slate-200 p-2 rounded">Theory</button>
                    </div>
                    <div id="notes-list"></div>
                </div>

                <div id="activity-log-container" class="w-full hidden">
                     <div class="back-nav">
                        <button id="activity-back-btn" class="back-btn-circle"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="text-2xl font-bold">History</h2>
                         <button id="clear-log-btn" class="text-red-500 text-sm ml-auto">Clear</button>
                    </div>
                     <div class="flex gap-2 mb-4">
                        <button id="log-filter-all" class="flex-1 bg-slate-200 p-2 rounded">All</button>
                        <button id="log-filter-quizzes" class="flex-1 bg-slate-200 p-2 rounded">Quiz</button>
                        <button id="log-filter-lectures" class="flex-1 bg-slate-200 p-2 rounded">Video</button>
                    </div>
                    <div id="all-summary" class="hidden"><span id="all-lectures-progress"></span><span id="all-questions-progress"></span></div>
                    <div id="quiz-summary" class="hidden"><span id="total-correct-answers"></span><span id="total-incorrect-answers"></span><span id="overall-accuracy"></span></div>
                    <div id="lecture-summary" class="hidden"><span id="lectures-viewed-count"></span><span id="chapters-started-count"></span></div>
                    <canvas id="activity-chart" class="mb-4"></canvas>
                    <div id="activity-log-list" class="space-y-2"></div>
                </div>

                <div id="library-container" class="w-full hidden">
                     <div class="back-nav">
                        <button id="library-back-btn" class="back-btn-circle"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="text-2xl font-bold">Library</h2>
                    </div>
                    <div id="library-loader" class="loader hidden"></div>
                    <div id="library-list"></div>
                </div>
                
                <div id="list-container" class="w-full hidden">
                    <div class="back-nav">
                         <button id="list-back-btn" class="back-btn-circle"><i class="fas fa-arrow-left"></i></button>
                         <h2 id="list-title" class="text-2xl font-bold">List</h2>
                    </div>
                    <div id="list-items" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                </div>

            </div>

            <nav class="bottom-nav md:hidden">
                <button class="bottom-item active" data-target="home"><i class="fas fa-home"></i> <span>Home</span></button>
                <button class="bottom-item" data-target="lectures"><i class="fas fa-play-circle"></i> <span>Lectures</span></button>
                <button class="bottom-item" data-target="exams"><i class="fas fa-question-circle"></i> <span>Exams</span></button>
                <button class="bottom-item" data-target="notes"><i class="fas fa-sticky-note"></i> <span>Notes</span></button>
            </nav>

        </main>
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        
        <div id="user-card-modal" class="bg-white rounded-xl p-6 w-full max-w-sm hidden relative">
            <button id="user-card-close-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            <div class="text-center">
                <img id="user-avatar" src="" class="w-20 h-20 rounded-full mx-auto mb-3 border-4 border-blue-100">
                <h3 id="card-user-name" class="font-bold text-xl"></h3>
                <p id="card-user-nickname" class="text-gray-500 text-sm"></p>
                <button id="edit-profile-btn" class="text-blue-500 text-sm mt-2">Edit Profile</button>
            </div>
            <div id="profile-details-view" class="mt-6 border-t pt-4 space-y-3">
                <div class="flex justify-between"><span>Score</span><span id="card-quiz-score" class="font-bold text-blue-600"></span></div>
                <div class="flex justify-between"><span>Plan</span><span id="card-subscription-status" class="font-bold"></span></div>
                <div class="flex justify-between"><span>Expires</span><span id="card-subscription-expiry" class="text-xs"></span></div>
                <div class="flex justify-between"><span>Exam Date</span><span id="card-exam-date"></span></div>
                <div class="flex justify-between"><span>Time</span><span id="card-days-left" class="font-bold text-red-500"></span></div>
            </div>
            <div id="profile-edit-view" class="hidden mt-4">
                <input id="edit-nickname" type="text" class="w-full p-2 border rounded mb-2" placeholder="Nickname">
                <input id="edit-exam-date" type="date" class="w-full p-2 border rounded mb-2">
                <div id="avatar-selection-grid" class="grid grid-cols-5 gap-2 mb-4"></div>
                <div class="flex gap-2">
                    <button id="cancel-edit-profile-btn" class="flex-1 bg-gray-200 p-2 rounded">Cancel</button>
                    <button id="save-profile-btn" class="flex-1 bg-blue-600 text-white p-2 rounded">Save</button>
                </div>
                <p id="profile-edit-error" class="text-red-500 text-xs hidden"></p>
            </div>
        </div>

        <div id="registration-modal" class="hidden bg-white p-6 rounded max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">Create Account</h3>
            <form id="registration-form" class="space-y-3">
                <input id="register-name" type="text" placeholder="Name" required class="w-full border p-2 rounded">
                <input id="register-username" type="text" placeholder="Username" required class="w-full border p-2 rounded">
                <input id="register-email" type="email" placeholder="Email" required class="w-full border p-2 rounded">
                <input id="register-mobile" type="text" placeholder="Mobile" required class="w-full border p-2 rounded">
                <input id="register-password" type="password" placeholder="Password" required class="w-full border p-2 rounded">
                <input id="register-confirm-password" type="password" placeholder="Confirm" required class="w-full border p-2 rounded">
                <input id="register-country" type="text" placeholder="Country" required class="w-full border p-2 rounded">
                <input id="register-study-type" type="text" placeholder="Study Type" class="w-full border p-2 rounded">
                <input id="register-exam-date" type="date" class="w-full border p-2 rounded">
                <p id="registration-error" class="text-red-500 hidden"></p>
                <p id="registration-success" class="text-green-500 hidden"></p>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="register-cancel-btn" type="button" class="px-4 py-2 bg-gray-200 rounded">Cancel</button>
                    <button id="register-submit-btn" type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Register</button>
                </div>
            </form>
        </div>

        <div id="confirmation-modal" class="hidden bg-white p-6 rounded max-w-sm">
            <h3 id="modal-title" class="font-bold mb-2"></h3>
            <p id="modal-text" class="mb-4"></p>
            <div class="flex justify-end gap-2">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 rounded">No</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded">Yes</button>
            </div>
        </div>

        <div id="note-modal" class="hidden bg-white p-6 rounded w-full max-w-md">
            <h3 id="note-modal-title" class="font-bold mb-2">Note</h3>
            <textarea id="note-textarea" class="w-full h-32 border p-2 rounded"></textarea>
            <div class="flex justify-end gap-2 mt-2">
                <button id="note-cancel-btn" class="px-4 py-2 bg-gray-200 rounded">Cancel</button>
                <button id="note-save-btn" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
            </div>
        </div>

        <div id="create-plan-modal" class="hidden bg-white p-6 rounded max-w-md">
            <input id="new-plan-name" type="text" placeholder="Plan Name" class="w-full border p-2 rounded mb-2">
            <input id="new-plan-start-date" type="date" class="w-full border p-2 rounded mb-2">
            <input id="new-plan-end-date" type="date" class="w-full border p-2 rounded mb-2">
            <p id="create-plan-error" class="text-red-500 hidden"></p>
            <div class="flex justify-end gap-2 mt-2">
                <button id="cancel-create-plan-btn" class="px-4 py-2 bg-gray-200 rounded">Cancel</button>
                <button id="confirm-create-plan-btn" class="px-4 py-2 bg-green-600 text-white rounded">Create</button>
            </div>
        </div>
        
        <div id="messenger-modal" class="hidden bg-white p-6 rounded max-w-md relative">
             <button id="messenger-close-btn" class="absolute top-2 right-2 text-xl">&times;</button>
             <div id="messages-list" class="h-64 overflow-y-auto bg-slate-50 p-2 rounded mb-2"></div>
             <div class="flex gap-2">
                 <input id="message-input" type="text" class="flex-1 border p-2 rounded">
                 <button id="send-message-btn" class="bg-blue-600 text-white px-4 rounded"><i class="fas fa-paper-plane"></i></button>
             </div>
             <p id="messenger-error" class="text-red-500 hidden"></p>
        </div>

        <div id="announcements-modal" class="hidden bg-white p-6 rounded max-w-md">
             <div id="announcements-list"></div>
             <button id="announcements-close-btn" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded w-full">Close</button>
        </div>

        <div id="clear-log-modal" class="hidden bg-white p-6 rounded max-w-sm">
             <button id="clear-quiz-logs-btn" class="w-full bg-yellow-100 text-yellow-800 p-2 rounded mb-2">Clear Quiz Logs</button>
             <button id="clear-lecture-logs-btn" class="w-full bg-teal-100 text-teal-800 p-2 rounded mb-2">Clear Lecture Logs</button>
             <button id="clear-all-logs-btn" class="w-full bg-red-100 text-red-800 p-2 rounded mb-2">Clear All</button>
             <button id="clear-log-cancel-btn" class="w-full bg-gray-200 p-2 rounded">Cancel</button>
        </div>

        <div id="question-navigator-modal" class="hidden bg-white p-6 rounded max-w-lg">
             <div id="navigator-grid" class="grid grid-cols-5 gap-2 max-h-64 overflow-y-auto"></div>
             <button id="navigator-close-btn" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded w-full">Close</button>
        </div>

         <div id="osce-navigator-modal" class="hidden bg-white p-6 rounded max-w-lg">
             <div id="osce-navigator-content"></div>
             <button id="osce-navigator-close-btn" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded w-full">Close</button>
         </div>

         <div id="image-viewer-modal" class="hidden bg-white p-2 rounded shadow-xl relative max-w-4xl">
             <button id="image-viewer-close-btn" class="absolute top-0 right-0 text-3xl p-2">&times;</button>
             <img id="modal-image" class="max-w-full max-h-[80vh]">
         </div>
         
         <div id="onboarding-modal" class="hidden bg-white p-6 rounded max-w-sm text-center">
             <h2 class="text-xl font-bold mb-2">What's New</h2>
             <button id="start-tour-btn" class="bg-blue-600 text-white px-4 py-2 rounded w-full mb-2">Start Tour</button>
             <button id="skip-tour-btn" class="text-gray-500">Skip</button>
         </div>
         <div id="tour-tooltip" class="hidden absolute bg-white p-4 rounded shadow-lg z-50 w-64">
             <h3 id="tour-title" class="font-bold"></h3>
             <p id="tour-text" class="text-sm mb-2"></p>
             <div class="flex justify-between">
                 <span id="tour-step-count" class="text-xs text-gray-400"></span>
                 <div>
                     <button id="tour-end-btn" class="text-xs mr-2">End</button>
                     <button id="tour-next-btn" class="text-xs bg-blue-600 text-white px-2 py-1 rounded">Next</button>
                 </div>
             </div>
         </div>
          <div id="ios-install-modal" class="hidden bg-white p-6 rounded max-w-sm relative text-center">
             <button id="ios-install-close-btn" class="absolute top-2 right-2">&times;</button>
             <i class="fab fa-apple text-4xl mb-2"></i>
             <p>Tap Share -> Add to Home Screen</p>
         </div>

    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW failed', err));
            });
        }
    </script>

    <script type="module" src="js/main.js"></script>
    <script src="js/login-animation.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // Helper to trigger clicks on hidden original buttons
            const trigger = (id) => { const el = document.getElementById(id); if(el) el.click(); };

            // 1. Navigation Logic (Sidebar + Bottom Nav)
            const navItems = document.querySelectorAll('.nav-item, .bottom-item');
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const target = item.getAttribute('data-target');

                    // Update UI Active State
                    navItems.forEach(el => el.classList.remove('active'));
                    document.querySelectorAll(`[data-target="${target}"]`).forEach(el => el.classList.add('active'));

                    // Trigger Logic
                    if(target === 'home') trigger('global-home-btn');
                    if(target === 'lectures') trigger('lectures-btn');
                    if(target === 'exams') trigger('qbank-btn');
                    if(target === 'osce') trigger('osce-btn');
                    if(target === 'planner') trigger('study-planner-btn');
                    if(target === 'notes') trigger('notes-btn');
                    if(target === 'activity') trigger('activity-log-btn');
                });
            });

            // 2. Sidebar Logout
            const logoutBtn = document.getElementById('sidebar-logout-btn');
            if(logoutBtn) logoutBtn.addEventListener('click', () => trigger('logout-btn'));

            // 3. Quick Actions
            const quickQuiz = document.getElementById('dashboard-quick-quiz-btn');
            if(quickQuiz) {
                quickQuiz.addEventListener('click', () => {
                    trigger('qbank-btn');
                    setTimeout(() => trigger('qbank-tab-practice'), 50);
                });
            }

            // 4. Login View Toggle (Observing main container visibility)
            const observer = new MutationObserver((mutations) => {
                const mainMenu = document.getElementById('main-menu-container');
                const loginWrapper = document.getElementById('login-container-wrapper');
                const appShell = document.getElementById('app-shell');

                // If main menu is visible (user logged in)
                if (!mainMenu.classList.contains('hidden')) {
                    loginWrapper.classList.add('hidden');
                    appShell.classList.remove('hidden');
                } else {
                    // If logged out
                    loginWrapper.classList.remove('hidden');
                    appShell.classList.add('hidden');
                }
            });

            const targetNode = document.getElementById('main-menu-container');
            if (targetNode) {
                observer.observe(targetNode, { attributes: true, attributeFilter: ['class'] });
            }
        });
    </script>
</body>
</html>
